<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CW1 Vue.js App</title>
    <!-- Vue CDN link  -->
    <script src="https://cdn.jsdelivr.net/npm/vue@2.7.16/dist/vue.js"></script>
    <!-- Font awesome link -->
    <link rel="stylesheet" href = "https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
    <!-- CSS style -->
    <link rel="stylesheet" href = "style.css">
    <!-- Render backend url -->
    <script>
        const API_URL = "https://cw1-backend-nnsd.onrender.com"
    </script>

</head>
<body>
    <!-- Mounting -->
    <div id="app">
        <header>
            <h1 v-text="sitename"></h1>
            <div class="search-bar">
                <input type="text" v-model="searchQuery" placeholder="Search..." v-on:input="searchLessons">
                <button v-on:click="searchLessons"><i class="fas fa-search"></i></button>
            </div>
            <button v-on:click="showShoppingCart" :disabled="cart.length === 0">
                <span class="fas fa-cart-plus"></span>
                Cart <span class="cart-count">{{totalCartCount}}</span>
            </button>
        </header>     

        <div class="content-wrap" v-if="showProduct">
            <!-- Sort controls -->
            <div class="sort-controls" v-if="showProduct">
                <label><strong>Sort by:</strong></label>
                <p><input type="radio" id="subject" value="subject" v-model="sortAttribute"><label for="subject">Subject</label></p>
                <p><input type="radio" id="location" value="location" v-model="sortAttribute"><label for="location">Location</label></p>
                <p><input type="radio" id="price" value="price" v-model="sortAttribute"><label for="price">Price</label></p>
                <p><input type="radio" id="spaces" value="spaces" v-model="sortAttribute"><label for="spaces">Spaces</label></p>
                <br>
                <label><strong>Order by:</strong></label>
                <p><input type="radio" id="ascending" value="asc" v-model="sortOrder"><label for="ascending">Ascending</label></p>
                <p><input type="radio" id="descending" value="desc" v-model="sortOrder"><label for="descending">Descending</label></p>
            </div>

            <main>
                <!-- No results message -->
                <div v-if="lessons.length === 0" class="no-results">
                    No results found.
                </div>

                <!-- Loop through lessons -->
                <div v-for="lesson in sortedLessons" :key="lesson.id" class="lesson-card">
                    <div class="lesson-details">
                        <p>Subject: {{lesson.subject}}</p>
                        <p>Location: {{lesson.location}}</p>
                        <p>Price: £{{lesson.price}}</p>
                        <p>Spaces left: {{lesson.spaces}}</p>               

                        <button v-on:click="addToCart(lesson)" v-if="canAddToCart(lesson)" id="add2cart_button">Add to Cart</button>
                        <button disabled="disabled" v-else >Add to Cart</button>

                        <div>
                            <span v-if="itemsLeft(lesson) === 0" class="stock-out">Out of Stock!</span>
                            <span v-else-if="itemsLeft(lesson) < 5" class="stock-low">Only {{itemsLeft(lesson)}} left!</span>
                            <span v-else class="stock-full">Buy Now!</span>
                        </div>
                        
                        <div>
                            <span v-for="n in lesson.rating"><i class="fas fa-star"></i></span><span v-for="n in 5 - lesson.rating"><i class="far fa-star"></i></span>
                        </div>                
                    </div> 
                    <div class="lesson-icon">
                        <img :src="`${API_URL}/images/${lesson.icon}`" :alt="lesson.subject">
                    </div>
                </div>
            </main>                       
        </div>
        
        <!-- Show Cart Page if show Product is false -->
        <main v-else class="cart-page">
            <h2>Shopping Cart: </h2>
            <div v-if="cart.length > 0" class="cart-container">
                <div v-for="(cartItem, index) in cart" :key="cartItem.id" class="lesson-card">
                    <div class="lesson-details">
                        <p>Subject: {{getLesson(cartItem.id).subject}}</p>
                        <p>Location: {{getLesson(cartItem.id).location}}</p>
                        <p>Price: £{{getLesson(cartItem.id).price}}</p>
                        <p>Quantity: {{cartItem.qty}}</p>    
                        <button v-on:click="removeFromCart(index)" class="remove-button"><i class="fas fa-trash-alt"></i> Remove </button>  
                    </div> 
                    <div class="lesson-icon">
                        <img :src="`${API_URL}/images/${getLesson(cartItem.id).icon}`" :alt="getLesson(cartItem.id).subject">
                    </div>
                </div>
            </div>

            <div v-else class="empty-cart">
                <p>Your cart is empty.</p>
                <button class="back-button" v-on:click="goBackToProducts">
                    <i class="fas fa-arrow-left"></i> Go Back
                </button>
            </div>

            <!-- Checkout Section -->
            <div class="checkout-section">
                <div v-if="!orderSubmitted" class="checkout-form">
                    <h2>Checkout</h2>     
                    <p  class="total-price"><strong>Total Price:</strong> £{{ totalPrice }}</p>   
                    
                    <div class="form-field">
                        <label><strong>First Name:</strong></label>            
                        <input v-model.trim="order.firstName" type="text" placeholder="Enter your first name" minlength="2" maxlength="25" pattern="[A-Za-z]+"><br>
                        <small v-if="order.firstName && !/^[A-Za-z]+$/.test(order.firstName)" class="error-msg">
                        Only letters allowed.
                        </small>
                        <small v-if="order.firstName && order.firstName.length < 2" class="error-msg">
                        Must be at least 2 characters.
                        </small>
                    
                    
                        <label><strong>Last Name:</strong></label>
                        <input v-model.trim="order.lastName" type="text" placeholder="Enter your last name" minlength="2" maxlength="25" required pattern="[A-Za-z]+"><br>
                        <small v-if="order.lastName && !/^[A-Za-z]+$/.test(order.lastName)" class="error-msg">
                        Only letters allowed.
                        </small>
                        <small v-if="order.lastName && order.lastName.length < 2" class="error-msg">
                        Must be at least 2 characters.
                        </small>
                                    
                        <label><strong>Phone Number:</strong></label>
                        <input v-model.trim="order.phone" type="tel" placeholder="Eg: 000-00-000" minlength="10" maxlength="10" required pattern="[0-9]{3}-[0-9]{2}-[0-9]{3}"><br>
                        <small v-if="order.phone && !/^[0-9]{3}-[0-9]{2}-[0-9]{3}$/.test(order.phone)" class="error-msg">
                        Fill with correct format: 000-00-000.
                        </small>
                    </div>
                    
                        <button v-on:click="checkout" :disabled="!isValidOrder"  class="checkout-button">
                        Checkout
                    </button>
                </div>   
                
                <div v-else class="confirmation">
                    <div class="confirmation-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>

                    <h3>Order Confirmed!</h3>
                    <p>Your order has been successfully submitted. Details are below:</p>

                    <div class="order-info">
                        <h4>Order Details</h4>

                        <div class="order-items-grid">
                            <div class="order-item-label">First Name:</div>
                            <div class="order-item-value">{{ submittedOrder.firstName }}</div>

                            <div class="order-item-label">Last Name:</div>
                            <div class="order-item-value">{{ submittedOrder.lastName }}</div>

                            <div class="order-item-label">Phone Number:</div>
                            <div class="order-item-value">{{ submittedOrder.phone }}</div>
                        </div>

                        <h4 style="margin-top: 20px;">Lessons Ordered</h4>

                        <!-- Loop through lesson details -->
                        <div class="lesson-item-grid" v-for="item in submittedOrder.items" :key="item.id">

                            <div class="order-item-label">Subject:</div>
                            <div class="order-item-value">{{ item.subject }}</div>

                            <div class="order-item-label">Location:</div>
                            <div class="order-item-value">{{ item.location }}</div>

                            <div class="order-item-label">Price:</div>
                            <div class="order-item-value">£{{ item.price }}</div>

                            <div class="order-item-label">Quantity:</div>
                            <div class="order-item-value">{{ item.qty }}</div>
                        </div>

                        <div class="order-total">
                            Total: £{{ submittedTotal }}
                        </div>
                    </div>
                </div>
            </div> 
        </main>
    </div>

    <!-- MAKING -->
    <script type="text/javascript">
        let webstore = new Vue({
            el: '#app',
            data: {
                sitename: 'After School Club',
                API_URL: "https://cw1-backend-nnsd.onrender.com",
                sortAttribute: 'subject', //set to default
                sortOrder: 'asc',
                lessons: [],
                cart : [],
                order: {
                    firstName: '',
                    lastName: '',
                    phone: ''
                },
                submittedOrder: {},
                submittedTotal: 0,
                orderSubmitted: false,
                searchQuery: '',
                showProduct: true
                },

                mounted() {
                    // Fetch lessons from mongodb 
                    fetch(`${API_URL}/lessons`)
                        .then(res => res.json())
                        .then(data => { this.lessons = data });
                },

                methods: {
                    addToCart: function(lesson){
                        if (lesson.spaces > 0){
                            lesson.spaces -- // decrement available space
                        const existing = this.cart.find((item) => item.id === lesson.id);
                            if (existing) {
                            existing.qty++;
                            } else {
                            this.cart.push({ id: lesson.id, qty: 1 });
                            }
                        }
                    },
                    canAddToCart: function(lesson){
                        return lesson.spaces > 0
                    },
                    showShoppingCart: function(){
                        // Ternary Operator which toggle b/w true and false so when its true change to false
                        if (this.cart.length > 0){
                        this.showProduct = this.showProduct ? false : true}
                    },
                    removeFromCart(index) {
                        const cartItem = this.cart[index];
                        if (!cartItem) return;
                        const lesson = this.getLesson(cartItem.id);
                        if (lesson) lesson.spaces++;
                        if (cartItem.qty > 1) {
                            cartItem.qty--;
                        } else {
                        this.cart.splice(index, 1); // remove one item with that index
                        }
                    },
                    itemsLeft(lesson){
                        return lesson.spaces
                    },
                    getLesson(id) {
                        return this.lessons.find(item => item.id === id) || {};
                    },
                    goBackToProducts() {
                        this.showProduct = true;
                        this.orderSubmitted = false;
                    },
                    applyCartSpaces() {
                        for (const item of this.cart) {
                            const lesson = this.lessons.find(l => l.id === item.id);
                            if (lesson) {
                                lesson.spaces -= item.qty;
                            }
                        }
                    },
                    async checkout() {
                        if (!this.isValidOrder) {
                            alert("Please fill out all fields correctly before checking out!");
                            return;
                        }

                        const cartItemsWithDetails = this.cart.map(item => {
                            const lesson = this.getLesson(item.id);
                            return {
                                id: item.id,
                                subject: lesson.subject,
                                location: lesson.location,
                                price: lesson.price,
                                spaces: lesson.spaces,
                                qty: item.qty
                            };                 
                        });
                        
                        try {
                            const response = await fetch(`${API_URL}/order`, {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({
                                    firstName: this.order.firstName,
                                    lastName: this.order.lastName,
                                    phone: this.order.phone,
                                    cartItems: cartItemsWithDetails
                                })
                            });

                            const result = await response.json();
                            alert(result.message);

                            // Update spaces after order submitted
                            for (const item of cartItemsWithDetails) {
                                await fetch(`${API_URL}/lessons/${item.id}`, {
                                    method: "PUT",
                                    headers: { "Content-Type": "application/json" },
                                    body: JSON.stringify({ spaces: this.getLesson(item.id).spaces })
                                });
                            }

                            this.submittedOrder = { ...this.order, items: cartItemsWithDetails };
                            this.submittedTotal = this.totalPrice;
                            this.orderSubmitted = true;

                            this.cart = [];
                            this.order = { firstName: "", lastName: "", phone: "" };

                        } catch (err) {
                            console.error("Checkout error:", err);
                            alert("Failed to submit order.");
                        }
                    },

                    async searchLessons() {
                        try {
                        const response = await fetch(`${API_URL}/search?query=${this.searchQuery}`);
                        const data = await response.json();
                        this.lessons = data;  // update lessons with filtered ones
                        this.applyCartSpaces();
                        } catch (error) {
                        console.error('Search failed:', error);
                        }
                    },
                },

                computed: {
                    sortedLessons() {
                    // Copy lessons array for sorting
                    return this.lessons.slice().sort((a, b) => {
                        let valueA = a[this.sortAttribute];
                        let valueB = b[this.sortAttribute];

                        // Compare strings case-insensitively
                        if (typeof valueA === 'string') {
                        valueA = valueA.toLowerCase();
                        valueB = valueB.toLowerCase();
                        }

                        // if valueA should come before B, then return -1 when sorting in asc and 1 in desc
                        //  if valueA should be after B, then return 1 when sorting in asc and -1 in desc
                        // return 0 if they are equal, no change in order
                        if (valueA < valueB) return this.sortOrder === 'asc' ? -1 : 1;
                        if (valueA > valueB) return this.sortOrder === 'asc' ? 1 : -1;
                        return 0;
                        });
                    },                    
                    totalCartCount(){
                        let total = 0;
                        for (let i = 0; i < this.cart.length; i++) {
                            total += this.cart[i].qty;
                        }
                        return total;
                    },   
                    totalPrice() {
                    return this.cart.reduce((sum, item) => {
                        const lesson = this.getLesson(item.id);
                        return sum + lesson.price * item.qty;}, 0); // running total sum starting at 0
                    },  
                    isValidOrder() {
                    const nameRegex = /^[A-Za-z]+$/;
                    const phoneRegex = /^[0-9]{3}-[0-9]{2}-[0-9]{3}$/;
                    return (
                        nameRegex.test(this.order.firstName) && this.order.firstName.length >= 2 &&
                        this.order.firstName.length <= 25 &&
                        nameRegex.test(this.order.lastName) && this.order.lastName.length >= 2 &&
                        this.order.lastName.length <= 25 &&
                        phoneRegex.test(this.order.phone));
                    },
                },           
            });
    </script>
</body>
</html>